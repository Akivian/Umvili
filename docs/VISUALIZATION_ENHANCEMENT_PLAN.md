# 智能体训练可视化增强方案

## 一、现状分析

### 当前可视化能力
- ✅ 环境可视化：糖分布地图、智能体位置
- ✅ 整体统计：种群数量、平均糖量、多样性指数
- ❌ **缺失**：智能体训练指标（损失函数、Q值、收敛程度）
- ❌ **缺失**：智能体行为策略可视化

### 数据来源分析

#### IQL智能体 (`src/marl/iql_agent.py`)
- `training_stats` 包含：
  - `q_values`: Q值历史
  - `losses`: 损失函数历史
  - `td_errors`: TD误差历史
  - `exploration_rate`: 探索率历史
  - `rewards`: 奖励历史
- `get_training_info()`: 返回训练信息摘要

#### QMIX训练器 (`src/marl/qmix_trainer.py`)
- `training_stats` 包含：
  - `losses`: 联合损失
  - `q_values`: 联合Q值
  - `td_errors`: TD误差
  - `mixing_losses`: 混合网络损失
- `get_training_stats()`: 返回详细训练统计

#### QMIX智能体 (`src/marl/qmix_agent.py`)
- `training_stats` 包含：
  - `q_values`: Q值历史
  - `losses`: 损失历史
  - `td_errors`: TD误差
  - `exploration_rate`: 探索率
- `get_training_info()`: 返回训练信息

## 二、可视化方案设计

### 2.1 核心指标可视化

#### 阶段1：基础训练指标（优先级：高）
1. **损失函数曲线**
   - 显示所有学习型智能体的平均损失
   - 支持按智能体类型分组显示（IQL、QMIX）
   - 实时更新，显示最近N步的损失趋势

2. **Q值变化趋势**
   - 显示平均Q值随时间的变化
   - 支持按智能体类型分组
   - 显示Q值的滑动平均，减少噪声

#### 阶段2：高级训练指标（优先级：中）
3. **TD误差曲线**
   - 显示时序差分误差的变化
   - 帮助判断学习稳定性

4. **探索率曲线**
   - 显示ε-贪婪策略的探索率衰减
   - 帮助理解探索-利用平衡

#### 阶段3：行为策略可视化（优先级：中-低）
5. **动作分布热图**
   - 显示智能体在不同状态下的动作选择分布
   - 帮助理解策略学习过程

6. **奖励分布**
   - 显示奖励的分布和趋势
   - 帮助评估奖励设计是否合理

### 2.2 技术实现方案

#### 数据收集层
- 在 `simulation.py` 的 `get_simulation_data()` 中添加 `training_metrics` 字段
- 从智能体和训练器收集训练统计信息
- 按智能体类型聚合数据

#### 可视化层
- 扩展 `RealTimeChart` 类支持多线图表（按类型分组）
- 在 `AcademicVisualizationSystem` 中添加新的图表组件
- 优化布局，确保新图表不影响现有功能

#### 性能优化
- 使用滑动窗口限制数据点数量（如最近200个点）
- 降低更新频率（如每N步更新一次）
- 使用数据采样减少绘制负担

## 三、逐级实现路线

### 阶段1：数据收集基础设施（预计：2-3小时）

#### 1.1 扩展 SimulationMetrics
**文件**: `src/core/simulation.py`

```python
@dataclass
class TrainingMetrics:
    """训练指标数据类"""
    agent_type: str
    avg_loss: float = 0.0
    avg_q_value: float = 0.0
    avg_td_error: float = 0.0
    exploration_rate: float = 0.0
    training_steps: int = 0
    sample_count: int = 0
```

#### 1.2 在 Simulation 中添加训练数据收集
**文件**: `src/core/simulation.py`

- 在 `_collect_metrics()` 中添加 `_collect_training_metrics()` 调用
- 实现 `_collect_training_metrics()` 方法：
  - 遍历所有智能体，收集训练信息
  - 从训练器收集统计信息
  - 按类型聚合数据

#### 1.3 在 get_simulation_data() 中暴露训练数据
- 添加 `training_metrics` 字段到返回字典

**验收标准**:
- [ ] 能够从IQL智能体收集训练统计
- [ ] 能够从QMIX训练器收集训练统计
- [ ] 数据按智能体类型正确聚合

---

### 阶段2：基础图表实现（预计：3-4小时）

#### 2.1 扩展 RealTimeChart 支持多线显示
**文件**: `src/utils/visualization.py`

- 添加 `MultiLineChart` 类，支持多条曲线
- 每条曲线可以有不同的颜色和标签
- 支持动态添加/移除曲线

#### 2.2 实现损失函数图表
**文件**: `src/utils/visualization.py`

- 在 `AcademicVisualizationSystem._initialize_charts()` 中添加损失图表
- 在 `_update_charts()` 中更新损失数据
- 支持按类型显示（IQL、QMIX分别显示）

#### 2.3 实现Q值趋势图表
**文件**: `src/utils/visualization.py`

- 添加Q值图表组件
- 显示平均Q值随时间变化
- 支持多类型智能体对比

**验收标准**:
- [ ] 损失函数曲线能够实时显示
- [ ] Q值趋势曲线能够实时显示
- [ ] 图表布局合理，不影响现有功能
- [ ] 性能良好，不影响模拟速度

---

### 阶段3：高级指标可视化（预计：2-3小时）

#### 3.1 TD误差曲线
- 添加TD误差图表
- 显示误差的变化趋势和稳定性

#### 3.2 探索率曲线
- 添加探索率图表
- 显示ε-贪婪策略的衰减过程

**验收标准**:
- [ ] 所有新增图表都能正常显示
- [ ] 数据更新及时准确

---

### 阶段4：优化和增强（预计：2-3小时）

#### 4.1 性能优化
- 实现数据采样（如每5步更新一次）
- 限制历史数据点数量（滑动窗口）
- 优化绘制性能

#### 4.2 UI优化
- 调整图表布局，确保所有图表可见
- 添加图表切换功能（可选）
- 改进图表标签和说明

#### 4.3 错误处理
- 处理数据缺失情况
- 处理异常值（NaN、Inf）
- 添加数据验证

**验收标准**:
- [ ] 性能满足要求（FPS > 30）
- [ ] 界面美观易用
- [ ] 错误处理完善

---

### 阶段5：行为策略可视化（可选，预计：4-5小时）

#### 5.1 动作分布可视化
- 实现动作选择热图
- 显示智能体在不同状态下的动作偏好

#### 5.2 策略收敛指标
- 添加策略熵指标
- 显示策略的确定性程度

**验收标准**:
- [ ] 行为策略可视化清晰易懂
- [ ] 能够帮助理解智能体学习过程

---

## 四、技术细节

### 4.1 数据收集策略

```python
def _collect_training_metrics(self) -> Dict[str, TrainingMetrics]:
    """收集训练指标"""
    metrics_by_type = {}
    
    # 从智能体收集
    for agent in self.agent_manager.agents:
        if hasattr(agent, 'get_training_info'):
            agent_type = agent.agent_type.value
            training_info = agent.get_training_info()
            
            if agent_type not in metrics_by_type:
                metrics_by_type[agent_type] = TrainingMetrics(agent_type=agent_type)
            
            # 聚合数据
            metrics_by_type[agent_type].avg_loss += training_info.get('avg_loss', 0)
            # ... 其他指标
    
    # 从训练器收集（QMIX）
    for agent_type, trainer in self.marl_trainers.items():
        if hasattr(trainer, 'get_training_stats'):
            stats = trainer.get_training_stats()
            # 聚合训练器数据
    
    return metrics_by_type
```

### 4.2 图表更新策略

- **更新频率**: 每5步更新一次（可配置）
- **数据窗口**: 保留最近200个数据点
- **采样策略**: 如果数据点过多，进行均匀采样

### 4.3 布局设计

```
┌─────────────────────────────────────────┐
│  环境可视化区域                          │
│  (现有)                                  │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│  控制面板 (现有)                         │
│  ┌───────────────────────────────────┐  │
│  │ 损失函数曲线                      │  │
│  │ [IQL] [QMIX]                      │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ Q值趋势                           │  │
│  │ [IQL] [QMIX]                      │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ TD误差 (阶段3)                    │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │ 探索率 (阶段3)                     │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## 五、风险评估

### 5.1 性能风险
- **风险**: 实时绘制多条曲线可能影响性能
- **缓解**: 使用数据采样和限制历史数据点数量

### 5.2 数据质量风险
- **风险**: 训练数据可能包含异常值
- **缓解**: 添加数据验证和异常值处理

### 5.3 兼容性风险
- **风险**: 新功能可能影响现有可视化
- **缓解**: 保持向后兼容，新功能可选启用

## 六、测试计划

### 6.1 单元测试
- 测试数据收集函数
- 测试图表更新逻辑
- 测试数据聚合算法

### 6.2 集成测试
- 测试完整的数据流（智能体 → 模拟 → 可视化）
- 测试多类型智能体场景
- 测试长时间运行稳定性

### 6.3 性能测试
- 测试不同智能体数量下的性能
- 测试图表更新对FPS的影响
- 测试内存使用情况

## 七、预期效果

### 7.1 短期效果（阶段1-2）
- ✅ 能够实时查看损失函数曲线
- ✅ 能够实时查看Q值变化趋势
- ✅ 了解模型收敛情况

### 7.2 中期效果（阶段3-4）
- ✅ 全面了解训练过程
- ✅ 能够诊断训练问题
- ✅ 优化训练参数

### 7.3 长期效果（阶段5）
- ✅ 深入理解智能体行为
- ✅ 改进算法设计
- ✅ 提升研究效率

## 八、时间估算

| 阶段 | 预计时间 | 累计时间 |
|------|---------|---------|
| 阶段1：数据收集 | 2-3小时 | 2-3小时 |
| 阶段2：基础图表 | 3-4小时 | 5-7小时 |
| 阶段3：高级指标 | 2-3小时 | 7-10小时 |
| 阶段4：优化增强 | 2-3小时 | 9-13小时 |
| 阶段5：行为可视化 | 4-5小时 | 13-18小时 |

**总计**: 13-18小时（不含阶段5为9-13小时）

## 九、下一步行动

1. **立即开始**: 阶段1 - 数据收集基础设施
2. **优先级**: 先实现损失函数和Q值曲线（阶段1-2）
3. **迭代开发**: 每个阶段完成后进行测试和验证
4. **用户反馈**: 根据使用情况调整后续阶段优先级


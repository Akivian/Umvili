# Umvili 多智能体强化学习平台 - 项目进度与规划

## 📊 当前项目状态

### ✅ 已完成功能（Phase 1-6, Phase 7部分）

#### 1. 核心可视化系统
- ✅ **MultiLineChart 组件**：支持多线实时绘制、动态曲线管理、图例显示
- ✅ **视图系统**：Overview / Training / Behavior / Debug / Network 五个视图，Tab 切换
- ✅ **训练指标可视化**：
  - Training Loss（按算法类型：IQL / QMIX）
  - Q-Value Trend
  - TD Error
  - Exploration Rate
- ✅ **行为策略可视化**：
  - Action Distribution（动作分布，带语义说明和 Top-3 摘要）
  - Reward Trend（奖励趋势曲线）
  - Policy Entropy（策略熵曲线）
- ✅ **Agent 类型分布面板**：数量、占比、平均糖量、RL 标记

#### 2. 数据收集基础设施
- ✅ `TrainingMetrics` 数据类（损失、Q值、TD误差、探索率、奖励）
- ✅ `_collect_training_metrics()` 方法（从 IQL/QMIX 智能体和训练器收集）
- ✅ 训练数据序列化与暴露（`get_simulation_data()`）

#### 3. 布局与性能优化
- ✅ 图表布局抽象（`_build_chart_grid`）
- ✅ 垂直分区系统（避免组件重叠）
- ✅ 更新频率控制（训练图表每5步，探索率每10步）
- ✅ 滑动窗口限制（最近200个数据点）

#### 4. 环境复杂度升级（Phase 6）✅
- ✅ **多资源类型系统**：
  - **Sugar（糖）**：基础资源，全地图分布，两个主要高地，持续再生
  - **Spice（香料）**：高价值稀缺资源，在特定小区域集中生成，消耗殆尽后随机重新生成
  - **Hazard（危险区）**：深血红色危险区域，从随机核心点开始，无规则向外扩散，形成连片危险区
- ✅ **动态资源系统**：
  - Spice 动态生成：在1-2个随机中心点周围极小范围内生成，消耗殆尽后延迟80步重新生成
  - Hazard 动态扩散：从核心点开始，每步从边缘随机向外扩散，老区域缓慢衰减解除
  - 资源竞争机制：Spice 奖励倍率5.0，鼓励智能体竞争抢夺
- ✅ **Hazard 危险机制**：
  - 危险区内资源完全清空且不再生成
  - 误入危险区的智能体每步损失大量 sugar（hazard_damage_per_step = 4.0）
  - 危险区稳定覆盖约9%地图，比 spice 区更大，形成明显的危险地带
  - 深血红色可视化，营造危险氛围
- ✅ **多资源可视化**：
  - Sugar：绿色渐变背景
  - Spice：金黄色半透明叠加（70%不透明度）
  - Hazard：深血红色半透明叠加（78%不透明度）
  - 清晰的绘制顺序和层次，避免视觉混乱

#### 5. 深度学习状态监测（Phase 7部分）✅
- ✅ **Q值热图可视化**：
  - `QValueHeatmapPanel` 组件，在环境地图上叠加显示 Q 值
  - 性能优化：增量更新、智能采样、缓存机制
  - 可切换开关，支持在 Behavior 视图中开启/关闭
- ✅ **网络内部状态可视化**：
  - `NetworkStatePanel` 组件，显示策略分布、策略熵、Q值统计
  - 网络参数统计（参数数量、梯度范数）
  - 集成到 Network 视图

---

## 🎯 下一阶段核心目标

### Phase 7: 深度学习状态监测（剩余部分，优先级：高）

#### 7.1 网络内部状态可视化（部分完成）
- ⚠️ **注意力热图**：需要网络架构支持注意力机制（当前未实现）
- ✅ **Q值热图**：已完成，在环境地图上叠加显示 Q 值
- ✅ **策略网络可视化**：已完成，显示策略分布、策略熵、Q值统计

#### 7.2 学习过程深度分析
- **梯度流分析**：显示训练过程中梯度的流动和变化
- **权重分布可视化**：网络权重的分布直方图、权重变化趋势
- **经验回放分析**：
  - Replay Buffer 中样本的分布（状态空间覆盖度）
  - 优先级回放的权重分布
  - 样本年龄分布

#### 7.3 多智能体协作分析
- **协作指标**：
  - 智能体之间的空间相关性（是否聚集）
  - 动作协调性（是否同时选择互补动作）
  - 资源分配公平性（Gini 系数）
- **通信可视化**：如果实现通信机制，可视化消息传递网络

**剩余实现路径**：
1. 如果未来引入注意力机制，添加 `get_attention_map()` 方法
2. 增强梯度流分析：显示训练过程中梯度的流动和变化
3. 权重分布可视化：网络权重的分布直方图、权重变化趋势
4. 经验回放分析：Replay Buffer 中样本的分布、优先级回放的权重分布

---

### Phase 8: 交互式实验配置系统（优先级：中-高）

#### 8.1 可视化参数调整面板
- **环境参数**：
  - 网格大小、糖生长速率、最大糖量
  - 资源类型开关、障碍物密度
  - 事件系统开关和频率
- **智能体参数**：
  - 学习率、折扣因子、探索率衰减
  - 网络结构（隐藏层维度）
  - Batch size、Replay buffer 大小
- **实时调整**：参数修改后立即生效（或提示需要重启模拟）

#### 8.2 实验配置管理
- **预设配置**：保存/加载常用实验配置（JSON/YAML）
- **配置对比**：同时运行多个配置，在同一个窗口中对比结果
- **参数扫描**：自动运行参数网格搜索，生成对比报告

#### 8.3 智能体管理界面
- **动态添加/删除智能体**：在运行时添加新智能体或移除现有智能体
- **智能体类型切换**：将现有智能体从一种类型转换为另一种
- **智能体状态查看**：点击智能体查看详细信息（位置、糖量、Q值、最近动作等）

**实现路径**：
1. 创建 `ParameterControlPanel` 组件（滑块、输入框、下拉菜单）
2. 实现配置序列化/反序列化（`ConfigManager`）
3. 在可视化系统中添加“Config”视图
4. 实现配置热更新机制（需要重启的提示）

---

### Phase 9: 数据导出与分析工具（优先级：中）

#### 9.1 数据导出
- **CSV 导出**：训练指标、环境统计、智能体状态历史
- **图像导出**：当前可视化窗口截图、图表单独导出（PNG/SVG）
- **视频导出**：录制模拟过程为视频（MP4）
- **JSON 导出**：完整模拟状态快照（可用于回放）

#### 9.2 数据分析工具
- **统计摘要**：自动生成实验报告（平均性能、收敛速度、稳定性指标）
- **对比分析**：多组实验的对比图表（箱线图、误差带图）
- **趋势分析**：长期趋势拟合、周期性检测

#### 9.3 回放系统
- **状态回放**：从保存的快照恢复模拟状态
- **时间轴控制**：快进、倒退、跳转到指定步数
- **对比回放**：同时播放多个实验的对比视频

**实现路径**：
1. 实现 `DataExporter` 类（CSV、图像、视频导出）
2. 在控制面板添加“Export”按钮和菜单
3. 实现 `ReplaySystem` 用于状态回放
4. 创建 `AnalysisTool` 用于离线数据分析

---

### Phase 10: 高级可视化增强（优先级：中-低）

#### 10.1 交互式图表
- **鼠标悬停**：显示精确数值、时间戳
- **缩放和平移**：鼠标滚轮缩放、拖拽平移
- **曲线选择**：点击图例切换曲线可见性
- **数据点标记**：标记重要事件（训练开始、参数变更等）

#### 10.2 3D 可视化（可选）
- **3D 环境视图**：地形高度、资源分布的三维展示
- **3D 轨迹**：智能体在状态空间中的轨迹可视化
- **3D 价值函数**：Q 值函数的三维表面图

#### 10.3 智能体视角可视化
- **第一人称视角**：跟随某个智能体，显示其观察到的环境
- **决策过程可视化**：显示智能体选择动作的推理过程
- **策略对比**：并排显示不同算法在同一状态下的决策差异

**实现路径**：
1. 为 `MultiLineChart` 添加交互事件处理（鼠标事件）
2. 实现缩放/平移逻辑
3. 可选：集成 3D 渲染库（如 PyOpenGL）用于 3D 可视化

---

## 📅 实现时间线

| 阶段 | 状态 | 预计时间 | 累计时间 | 优先级 |
|------|------|---------|---------|--------|
| Phase 6: 增强环境模拟 | ✅ 已完成 | 8-12 小时 | 8-12 小时 | 高 |
| Phase 7: 深度学习状态监测 | 🔄 部分完成 | 10-15 小时 | 18-27 小时 | 高 |
| Phase 8: 交互式实验配置 | ⏳ 待开始 | 6-10 小时 | 24-37 小时 | 中-高 |
| Phase 9: 数据导出与分析 | ⏳ 待开始 | 4-6 小时 | 28-43 小时 | 中 |
| Phase 10: 高级可视化增强 | ⏳ 待开始 | 6-10 小时 | 34-53 小时 | 中-低 |

**已完成**：Phase 6 全部 + Phase 7 核心部分（Q值热图、网络状态可视化）  
**剩余工作量**：约 16-31 小时（约 0.5-1 周全职开发）

---

## 🛠 技术实现要点

### 架构设计原则
1. **模块化**：每个新功能作为独立模块，通过接口集成
2. **可扩展性**：新环境类型、新可视化组件易于添加
3. **性能优先**：交互式操作不阻塞主循环，使用异步/后台线程
4. **向后兼容**：新功能不影响现有功能

### 关键技术选型
- **环境扩展**：基于 `SugarEnvironment` 继承，使用组合模式添加新特性
- **可视化增强**：扩展 `AcademicVisualizationSystem`，新增子视图和交互组件
- **配置管理**：使用 `dataclass` + JSON/YAML 序列化
- **数据导出**：使用 `pandas` 处理 CSV，`PIL`/`matplotlib` 处理图像，`opencv-python` 处理视频

### 性能优化策略
- **懒加载**：复杂可视化组件按需创建
- **数据采样**：大数据集自动降采样显示
- **缓存机制**：计算结果缓存，避免重复计算
- **异步导出**：数据导出在后台线程进行，不阻塞 UI

---

## 🎯 短期行动计划（接下来 1-2 周）

### Week 1: 环境增强 + 深度监测基础
1. **Day 1-2**：实现多资源环境系统
   - 扩展 `SugarEnvironment` 支持多资源类型
   - 添加资源竞争和平衡机制
   - 更新可视化显示多资源分布

2. **Day 3-4**：实现 Q 值热图可视化
   - 在 `LearningAgent` 中添加 `get_q_value_map()` 方法
   - 创建 `QValueHeatmapPanel` 组件
   - 集成到 Behavior 视图

3. **Day 5**：实现注意力机制可视化（如果算法支持）
   - 添加注意力权重收集
   - 创建 `AttentionHeatmapPanel` 组件

### Week 2: 交互配置 + 数据导出
1. **Day 1-2**：实现参数调整面板
   - 创建 `ParameterControlPanel` 组件
   - 实现配置序列化/加载
   - 添加“Config”视图

2. **Day 3**：实现数据导出功能
   - CSV 导出训练指标
   - 图像导出当前窗口
   - 添加导出按钮和菜单

3. **Day 4-5**：实现实验对比功能
   - 支持多配置同时运行
   - 对比图表显示
   - 实验报告生成

---

## 📝 验收标准

### Phase 6: 环境增强 ✅
- [x] 支持至少 3 种资源类型（Sugar / Spice / Hazard）
- [x] 资源分布可视化清晰（绿色糖、金黄色香料、深血红色危险区）
- [x] 智能体能够平衡多种资源（Spice 高奖励，Hazard 高惩罚）
- [x] 性能影响 < 10% FPS 下降（已验证）

### Phase 7: 深度监测（部分完成）
- [x] Q 值热图实时更新（已完成，带性能优化）
- [x] 网络状态可视化清晰易懂（策略分布、熵、Q值统计）
- [ ] 协作指标计算准确（待实现）
- [x] 不影响训练性能（已验证）

### Phase 8: 交互配置
- [ ] 参数调整界面友好
- [ ] 配置保存/加载功能正常
- [ ] 支持至少 2 个配置同时对比
- [ ] 参数修改有明确反馈

### Phase 9: 数据导出
- [ ] CSV 导出格式正确
- [ ] 图像导出质量良好
- [ ] 视频导出流畅（可选）
- [ ] 导出功能不阻塞 UI

### Phase 10: 高级可视化
- [ ] 图表交互流畅
- [ ] 缩放/平移功能正常
- [ ] 3D 可视化（如果实现）性能可接受

---

## 🔗 相关文档

- [架构设计](../ARCHITECTURE.md)
- [配置指南](../CONFIGURATION.md)
- [开发指南](../DEVELOPMENT.md)
- [MultiLineChart 使用指南](../MULTILINE_CHART_USAGE.md)

---

**最后更新**：2025年1月  
**文档版本**：3.0.0  
**项目状态**：Phase 1-6 已完成，Phase 7 部分完成（Q值热图、网络状态可视化），Phase 8-10 规划中

